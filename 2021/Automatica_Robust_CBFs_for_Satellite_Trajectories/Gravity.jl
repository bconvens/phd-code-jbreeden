module Gravity

using LinearAlgebra
import SatelliteToolbox
include("Utilities.jl");

mu_Eros = 4.46176546159e5;
R0_Eros = 1600;
C_Eros = [ 0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000;
           0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000;
          -0.0523567539128000  -0.0000364108109002   0.0831250837707000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000;
          -0.0012151900487400   0.0040303577178400   0.0014579796131100  -0.0097894206118800   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000;
           0.0125416077257000  -0.0000995005749676  -0.0180889123682000  -0.0003394814473900   0.0180540198220000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000;
          -0.0003653138609860  -0.0027071780527000  -0.0006649443209090   0.0042919267358600   0.0007507027011200  -0.0102055169391000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000;
          -0.0057501366478600  -0.0001153763068850   0.0065901659281800  -0.0030480308012100  -0.0077463161733600   0.0007405267063000   0.0060068257079700   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000;
          -0.0114956291594000   0.0018776559457800   0.0005344667362230  -0.0038099707483900  -0.0004392660841830   0.0036176663344800   0.0002573174368180  -0.0079759301265500   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000;
           0.0022428766370700   0.0004262643613060  -0.0030174297112100  -0.0005742276540080   0.0026220174426100   0.0008090018223960  -0.0021849126243200  -0.0009648789699160   0.0022947363277400   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000;
           0.0004826126168740  -0.0011532821630100  -0.0006405555372290   0.0013676310987100   0.0005282922926180  -0.0017861400159200  -0.0003867237684780   0.0024058853492600   0.0002743387625610  -0.0036477582211700   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000;
          -0.0012387888829200  -0.0003339460139830   0.0016752918988700   0.0003893302896260  -0.0014754953739500  -0.0004872551504870   0.0012397753799300   0.0005867862039400  -0.0011333559984600  -0.0005983116765200   0.0016349079169800   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000;
          -0.0002807626989150   0.0007989434552350   0.0003842854117300  -0.0008861233367380  -0.0003477534432910   0.0010390831429600   0.0002980695904740  -0.0012197375785100  -0.0002613576932420   0.0014012431597900   0.0002630662240250  -0.0017532344922000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000;
           0.0007698199770110   0.0002475253005540  -0.0010442386387500  -0.0002627010255200   0.0009269968713890   0.0002951163120000  -0.0007825431533210  -0.0003387410102670   0.0006831502556090   0.0003686352743280  -0.0007386728105660  -0.0003393534042470   0.0012759240938800   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000;
           0.0001740125112710  -0.0005825489575430  -0.0002441832178550   0.0006203782799250   0.0002364246466120  -0.0006787629937660  -0.0002214449941120   0.0007289210583070   0.0002074840976580  -0.0007431252503010  -0.0002136759109190   0.0007135644065610   0.0002457264027530  -0.0007305708060640   0.0000000000000000   0.0000000000000000   0.0000000000000000;
          -0.0005251371388500  -0.0001796847062750   0.0007129573693940   0.0001792522236770  -0.0006338436206370  -0.0001843354534450   0.0005323707664310   0.0001994844582220  -0.0004458542544400  -0.0002192690752880   0.0004153868248730   0.0002271524105300  -0.0004907329761200  -0.0002031752914360   0.0008442994622230   0.0000000000000000   0.0000000000000000;
          -0.0001145754230980   0.0004478336614610   0.0001633056067250  -0.0004645801765410  -0.0001643556428790   0.0004852759586790   0.0001603785281890  -0.0004898066580740  -0.0001519229238300   0.0004602381916720   0.0001492253624770  -0.0003908518068550  -0.0001661008587900   0.0002974287444770   0.0001965695258580  -0.0002506044207050   0.0000000000000000;
           0.0003856213324120   0.0001303937857130  -0.0005235842365160  -0.0001250755035430   0.0004650597028850   0.0001203573336900  -0.0003874973159190  -0.0001228900584220   0.0003129574710910   0.0001336588419940  -0.0002603122615810  -0.0001459499405260   0.0002411030134190   0.0001505270116970  -0.0002642507808230  -0.0001425198398450   0.0003853437367010];
S_Eros = [0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000;
          0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000;
          0.0000000000000000  -0.0000695327865749  -0.0260798728377000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000;
          0.0000000000000000   0.0034525220474800  -0.0005928170081950  -0.0122873852352000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000;
          0.0000000000000000   0.0001576155643210   0.0041185146578900  -0.0005887535179980  -0.0087254216153700   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000;
          0.0000000000000000  -0.0012340586166400   0.0002245436546990  -0.0012604114649300   0.0001182490442260  -0.0071068429457300   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000;
          0.0000000000000000  -0.0002060582950320  -0.0011311284042400   0.0018697820870400  -0.0011098120379300  -0.0031474480641700  -0.0006883443532510   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000;
          0.0000000000000000  -0.0003404618490660  -0.0002715691569930  -0.0006686936908690  -0.0010707599219800   0.0017777439797700  -0.0000559469579327  -0.0019516474945000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000;
          0.0000000000000000   0.0000785563031042   0.0002526391226560  -0.0001919111379840  -0.0002957052059380   0.0001781364057250  -0.0000591460346857  -0.0000022939016849   0.0012283451708300   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000;
          0.0000000000000000  -0.0002626433311530   0.0001315554824670   0.0007374634626310  -0.0002209628496200  -0.0010581198317500   0.0002329302937050   0.0011398476843500  -0.0001587194122690  -0.0009853017090130   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000;
          0.0000000000000000  -0.0000305975511636  -0.0000271271997598   0.0000767637611420  -0.0000429635256355  -0.0000756869012167   0.0002928682697030  -0.0000003287311310  -0.0008050851357840   0.0001370795418050   0.0019055009500700   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000;
          0.0000000000000000   0.0001604689520900  -0.0000435395986564  -0.0004532337997510   0.0000769370344564   0.0006668546044140  -0.0000856462333856  -0.0007719312040010   0.0000586844341029   0.0007805572369890  -0.0000112088326409  -0.0008324869535440   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000;
          0.0000000000000000   0.0000109556124169  -0.0000406490263457  -0.0000300154873157   0.0001303924016980   0.0000365589194879  -0.0003062456509710  -0.0000148431002588   0.0005878456150840  -0.0000442822710840  -0.0009893908133180   0.0001169331735020   0.0017138238353200   0.0000000000000000   0.0000000000000000   0.0000000000000000   0.0000000000000000;
          0.0000000000000000  -0.0001101715898490   0.0000066114216166   0.0003133330171820  -0.0000155881300219  -0.0004708531314040   0.0000224438574029   0.0005717809785200  -0.0000180143778418  -0.0006317288108760   0.0000011022691620   0.0007051306027580   0.0000077598664051  -0.0010110153653900   0.0000000000000000   0.0000000000000000   0.0000000000000000;
          0.0000000000000000  -0.0000043679773603   0.0000587432805333   0.0000145392919558  -0.0001452591994400  -0.0000252447811788   0.0002776002747050   0.0000280563761959  -0.0004585282332680  -0.0000124104718323   0.0006770356885090  -0.0000216292823537  -0.0009248087313250   0.0000519382186188   0.0013380709459500   0.0000000000000000   0.0000000000000000;
          0.0000000000000000   0.0000817507135843   0.0000075532040501  -0.0002336819027430  -0.0000092605300592   0.0003557601589070   0.0000054157033582  -0.0004428805257240  -0.0000025988048479   0.0005073258598020   0.0000063616703190  -0.0005791499525250  -0.0000110947598450   0.0007142955045660  -0.0000015039036249  -0.0011352359593700   0.0000000000000000;
          0.0000000000000000   0.0000030428713484  -0.0000610369286506  -0.0000114737410361   0.0001392535798830   0.0000239647530114  -0.0002442874966150  -0.0000358322090637   0.0003740973386090   0.0000385358107480  -0.0005163681207170  -0.0000272549821831   0.0006560956283910   0.0000079679990166  -0.0007919738272970   0.0000037083252947   0.0010449527127000];
Eros = SatelliteToolbox.GravityModel_Coefs{Float64}("Eros", mu_Eros, R0_Eros, :full, 16, C_Eros, S_Eros);
# Reference: https://sbnarchive.psi.edu/pds3/near/NEAR_A_5_COLLECTED_MODELS_V1_0/data/rss/n393coeff.tab

Eros_RA = 1.13630374224E+01; # degrees  
Eros_Dec = 1.72319592818E+01; # degrees
Eros_omega = 1.63938923164E+03; # degrees per day
Eros_omega_vec = [cos(deg2rad(Eros_Dec))*cos(deg2rad(Eros_RA));
                  cos(deg2rad(Eros_Dec))*sin(deg2rad(Eros_RA));
                  sin(deg2rad(Eros_Dec))] * deg2rad(Eros_omega)/24/3600; # rad/s
# Reference: https://sbnarchive.psi.edu/pds3/near/NEAR_A_5_COLLECTED_MODELS_V1_0/data/rss/landmark.tab

# At t=0, the body fixed frame of Eros (i.e. where all the coefficients above apply) is assumed
# to align with the inertial frame.

include("Eros.jl");

# I'm assuming that the frames for the shape model, gravity model, and rotation rate model
# happen to all be the same, but I have yet to find a file that confirms this, so these
# results should be considered notional rather than real mission representative.

function gravity_Eros(t, r)
    Rot = exp(skew(Eros_omega_vec)*t); # Rotation from body fixed to inertial
    s = Rot'*r;
    gB = SatelliteToolbox.compute_g(Eros, r, -1, -1);
    gI = Rot*gB;
    return gI;
end

function exp_skew(v)
    n = v/(norm(v) + 1e-10);
    theta = norm(v);
    Rot = I3*cos(theta) + (1-cos(theta))*n*n' + sin(theta)*skew(n);
    return Rot;
end

function obstacle_Eros(t,i)
    # Rot = exp(skew(Gravity.Eros_omega_vec)*t); # Rotation from body fixed to inertial
    
    # The matrix exponential is not differentiable so I wrote my own
    Rot = exp_skew(Gravity.Eros_omega_vec*t); # Rotation from body fixed to inertial
    
    rc = Rot*Gravity.r_Eros[i]; # in inertial frame
    vc = cross(Gravity.Eros_omega_vec, rc); # in inertial frame
    return rc, vc;
end

#################################################

r_Ceres = 476000;
mu_Ceres = 6.26325e10;

function gravity_Ceres(t, r)
    return -mu_Ceres*r/norm(r)^3;
end

function partial_gravity_Ceres(t, r, vc=[0;0;0])
    return 3*mu_Ceres*r*r'/norm(r)^5*(-vc) - mu_Ceres/norm(r)^3*(-vc);
end

I3 = [1.0 0.0 0.0;
      0.0 1.0 0.0;
      0.0 0.0 1.0];
function grad_gravity_Ceres(t, r)
    return 3*mu_Ceres*r*r'/norm(r)^5 - mu_Ceres*I3/norm(r)^3;
end

function obstacle_Ceres(t, args)
    rc = [0;0;0];
    vc = [0;0;0];
    uc = [0;0;0];
    udotc = [0;0;0];
    return rc, vc, uc, udotc;
end

end