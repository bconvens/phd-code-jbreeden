function [H, dHdt, dHdu] = Hecbf_func(t,x)
global sim_case
f = [0,1,0,0;
    0,0,0,0;
    0,0,0,1;
    0,0,0,0];
g = [0,0;1,0;0,0;0,1];
[h, dh_dx] = h_func(t,x);
hdot = dh_dx*f*x;
c = 1;
H = hdot + c*h;

if sim_case==1
    dhdot_dx = dhdot_parallel(x);
elseif sim_case==2
    dhdot_dx = dhdot_left(x);
else
    error('Unknown simulation case');
end

dHdt = c*hdot + dhdot_dx*f*x + dhdot_dx*g*mu_func(t,x);
dHdu = dhdot_dx*g;
end

function out = dhdot_parallel(x)
x1 = x(1); x2 = x(2); x3 = x(3); x4 = x(4);
out = [ ((2*x1 - 3)*((3*x4)/2 - (3*x2)/2 + x1*x2 + x3*x4))/(2*((x1 - 3/2)^2 + (x3 + 3/2)^2)^(3/2)) - x2/((x1 - 3/2)^2 + (x3 + 3/2)^2)^(1/2), -(x1 - 3/2)/((x1 - 3/2)^2 + (x3 + 3/2)^2)^(1/2), ((2*x3 + 3)*((3*x4)/2 - (3*x2)/2 + x1*x2 + x3*x4))/(2*((x1 - 3/2)^2 + (x3 + 3/2)^2)^(3/2)) - x4/((x1 - 3/2)^2 + (x3 + 3/2)^2)^(1/2), -(x3 + 3/2)/((x1 - 3/2)^2 + (x3 + 3/2)^2)^(1/2)];
end

function out = dhdot_left(x)
x1 = x(1); x2 = x(2); x3 = x(3); x4 = x(4);
arc_length = pi/2*4.5;
if x3 <= -3
    out = [ ((2*x1 - 3)*((3*x4)/2 - (3*x2)/2 + x1*x2 + x3*x4))/(2*((x1 - 3/2)^2 + (x3 + 3/2)^2)^(3/2)) - x2/((x1 - 3/2)^2 + (x3 + 3/2)^2)^(1/2), -(x1 - 3/2)/((x1 - 3/2)^2 + (x3 + 3/2)^2)^(1/2), ((2*x3 + 3)*((3*x4)/2 - (3*x2)/2 + x1*x2 + x3*x4))/(2*((x1 - 3/2)^2 + (x3 + 3/2)^2)^(3/2)) - x4/((x1 - 3/2)^2 + (x3 + 3/2)^2)^(1/2), -(x3 + 3/2)/((x1 - 3/2)^2 + (x3 + 3/2)^2)^(1/2)];
elseif z2 < -3+arc_length
    out = [ (x2*(2*x1 - 9*cos((2*x3)/9 + 2/3) + 6)^2)/(4*((x1 - (9*cos((2*x3)/9 + 2/3))/2 + 3)^2 + ((9*sin((2*x3)/9 + 2/3))/2 - 3/2)^2)^(3/2)) - x2/((x1 - (9*cos((2*x3)/9 + 2/3))/2 + 3)^2 + ((9*sin((2*x3)/9 + 2/3))/2 - 3/2)^2)^(1/2) - (x4*sin((2*x3)/9 + 2/3))/((x1 - (9*cos((2*x3)/9 + 2/3))/2 + 3)^2 + ((9*sin((2*x3)/9 + 2/3))/2 - 3/2)^2)^(1/2) + (x4*(2*cos((2*x3)/9 + 2/3)*((9*sin((2*x3)/9 + 2/3))/2 - 3/2) + 2*sin((2*x3)/9 + 2/3)*(x1 - (9*cos((2*x3)/9 + 2/3))/2 + 3))*(2*x1 - 9*cos((2*x3)/9 + 2/3) + 6))/(4*((x1 - (9*cos((2*x3)/9 + 2/3))/2 + 3)^2 + ((9*sin((2*x3)/9 + 2/3))/2 - 3/2)^2)^(3/2)), -(2*x1 - 9*cos((2*x3)/9 + 2/3) + 6)/(2*((x1 - (9*cos((2*x3)/9 + 2/3))/2 + 3)^2 + ((9*sin((2*x3)/9 + 2/3))/2 - 3/2)^2)^(1/2)), (x4*(2*cos((2*x3)/9 + 2/3)*((9*sin((2*x3)/9 + 2/3))/2 - 3/2) + 2*sin((2*x3)/9 + 2/3)*(x1 - (9*cos((2*x3)/9 + 2/3))/2 + 3))^2)/(4*((x1 - (9*cos((2*x3)/9 + 2/3))/2 + 3)^2 + ((9*sin((2*x3)/9 + 2/3))/2 - 3/2)^2)^(3/2)) - (x2*sin((2*x3)/9 + 2/3))/((x1 - (9*cos((2*x3)/9 + 2/3))/2 + 3)^2 + ((9*sin((2*x3)/9 + 2/3))/2 - 3/2)^2)^(1/2) - (x4*(2*sin((2*x3)/9 + 2/3)^2 - (4*sin((2*x3)/9 + 2/3)*((9*sin((2*x3)/9 + 2/3))/2 - 3/2))/9 + (4*cos((2*x3)/9 + 2/3)*(x1 - (9*cos((2*x3)/9 + 2/3))/2 + 3))/9 + 2*cos((2*x3)/9 + 2/3)^2))/(2*((x1 - (9*cos((2*x3)/9 + 2/3))/2 + 3)^2 + ((9*sin((2*x3)/9 + 2/3))/2 - 3/2)^2)^(1/2)) + (x2*(2*cos((2*x3)/9 + 2/3)*((9*sin((2*x3)/9 + 2/3))/2 - 3/2) + 2*sin((2*x3)/9 + 2/3)*(x1 - (9*cos((2*x3)/9 + 2/3))/2 + 3))*(2*x1 - 9*cos((2*x3)/9 + 2/3) + 6))/(4*((x1 - (9*cos((2*x3)/9 + 2/3))/2 + 3)^2 + ((9*sin((2*x3)/9 + 2/3))/2 - 3/2)^2)^(3/2)), -(2*cos((2*x3)/9 + 2/3)*((9*sin((2*x3)/9 + 2/3))/2 - 3/2) + 2*sin((2*x3)/9 + 2/3)*(x1 - (9*cos((2*x3)/9 + 2/3))/2 + 3))/(2*((x1 - (9*cos((2*x3)/9 + 2/3))/2 + 3)^2 + ((9*sin((2*x3)/9 + 2/3))/2 - 3/2)^2)^(1/2))];
else
    out = [ (x2*(2*x1 + 2*x3 - (9*pi)/2 + 12)^2)/(4*((x1 + x3 - (9*pi)/4 + 6)^2 + 9)^(3/2)) - x4/((x1 + x3 - (9*pi)/4 + 6)^2 + 9)^(1/2) - x2/((x1 + x3 - (9*pi)/4 + 6)^2 + 9)^(1/2) + (x4*(2*x1 + 2*x3 - (9*pi)/2 + 12)^2)/(4*((x1 + x3 - (9*pi)/4 + 6)^2 + 9)^(3/2)), -(2*x1 + 2*x3 - (9*pi)/2 + 12)/(2*((x1 + x3 - (9*pi)/4 + 6)^2 + 9)^(1/2)), (x2*(2*x1 + 2*x3 - (9*pi)/2 + 12)^2)/(4*((x1 + x3 - (9*pi)/4 + 6)^2 + 9)^(3/2)) - x4/((x1 + x3 - (9*pi)/4 + 6)^2 + 9)^(1/2) - x2/((x1 + x3 - (9*pi)/4 + 6)^2 + 9)^(1/2) + (x4*(2*x1 + 2*x3 - (9*pi)/2 + 12)^2)/(4*((x1 + x3 - (9*pi)/4 + 6)^2 + 9)^(3/2)), -(2*x1 + 2*x3 - (9*pi)/2 + 12)/(2*((x1 + x3 - (9*pi)/4 + 6)^2 + 9)^(1/2))];
end
end

% How to compute dhdot
% syms x1 x2 x3 x4;
% x = [x1; x2; x3; x4];
% h = h_func(0,x)
% Remove absolute values
% dh = jacobian(h, x)*[x2;0;x4;0]
% ddh = jacobian(dh, x)